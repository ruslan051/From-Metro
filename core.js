// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
window.optionalModulesLoaded = false;
window.optionalModulesLoading = false;

// –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
let currentUser = null;
let timerInterval = null;
let timerSeconds = 0;
let userId = null;
let selectedMinutes = 5;
let selectedCity = 'spb';
let selectedGender = 'male';
let currentPosition = '';
let currentMood = '';
let currentGroup = null;
let currentSelectedStation = null;
let globalRefreshInterval = null;

// –°–∫–∞–∑–æ—á–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è –º—É–∂—á–∏–Ω –∏ –∂–µ–Ω—â–∏–Ω
const maleNames = ['–ò–≤–∞–Ω-–¶–∞—Ä–µ–≤–∏—á', '–ö–æ—â–µ–π –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π', '–î–æ–±—Ä—ã–Ω—è –ù–∏–∫–∏—Ç–∏—á', '–õ–µ—à–∏–π', '–í–æ–¥—è–Ω–æ–π', '–ë–∞–±–∞–π', '–°–æ–ª–æ–≤–µ–π-–†–∞–∑–±–æ–π–Ω–∏–∫', '–ó–º–µ–π –ì–æ—Ä—ã–Ω—ã—á'];
const femaleNames = ['–í–∞—Å–∏–ª–∏—Å–∞ –ü—Ä–µ–º—É–¥—Ä–∞—è', '–ë–∞–±–∞ –Ø–≥–∞', '–¶–∞—Ä–µ–≤–Ω–∞-–õ—è–≥—É—à–∫–∞', '–°–Ω–µ–≥—É—Ä–æ—á–∫–∞', '–ú–∞—Ä—å—è-–ò—Å–∫—É—Å–Ω–∏—Ü–∞', '–ê–ª–µ–Ω—É—à–∫–∞', '–ö–∏–∫–∏–º–æ—Ä–∞', '–†—É—Å–∞–ª–∫–∞'];

// API endpoints
const API_BASE = 'https://metro-backend-xlkt.onrender.com/api';

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
let setupScreen, waitingRoomScreen, joinedRoomScreen;
let backToSetupBtn, backToWaitingBtn, leaveGroupBtn;
let enterWaitingRoomBtn, confirmStationBtn;
let wagonSelect, colorSelect, waitingTimer, waitingTimerDisplay, waitingTimerStatus;
let waitingStartTimerBtn, waitingStopTimerBtn, waitingTimerOptions, waitingTimerExpanded;
let positionCards, moodCards;
let groupMembersContainer, metroMap, requestsContainer;

// –°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
const stations = {
    spb: [
        '–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∞—è', '–ë–∞–ª—Ç–∏–π—Å–∫–∞—è', '–í–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∞—è', '–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è', '–ì–æ—Å—Ç–∏–Ω—ã–π –¥–≤–æ—Ä',
        '–ì–æ—Ä—å–∫–æ–≤—Å–∫–∞—è', '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∞—è', '–ï–ª–∏–∑–∞—Ä–æ–≤—Å–∫–∞—è', '–ó–≤–µ–Ω–∏–≥–æ—Ä–æ–¥—Å–∫–∞—è', '–ö–∏—Ä–æ–≤—Å–∫–∏–π –∑–∞–≤–æ–¥',
        '–õ–∞–¥–æ–∂—Å–∫–∞—è', '–õ–∏–≥–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç', '–õ–æ–º–æ–Ω–æ—Å–æ–≤—Å–∫–∞—è', '–ú–∞—è–∫–æ–≤—Å–∫–∞—è', '–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç',
        '–û–±–≤–æ–¥–Ω—ã–π –∫–∞–Ω–∞–ª', '–û–∑–µ—Ä–∫–∏', '–ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã', '–ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∞—è', '–ü–ª–æ—â–∞–¥—å –í–æ—Å—Å—Ç–∞–Ω–∏—è',
        '–ü–ª–æ—â–∞–¥—å –õ–µ–Ω–∏–Ω–∞', '–ü—Ä–∏–º–æ—Ä—Å–∫–∞—è', '–ü—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–∞—è', '–ü—Ä–æ—Å–ø–µ–∫—Ç –í–µ—Ç–µ—Ä–∞–Ω–æ–≤', '–ü—Ä–æ—Å–ø–µ–∫—Ç –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è',
        '–ü—É—à–∫–∏–Ω—Å–∫–∞—è', '–°–∞–¥–æ–≤–∞—è', '–°–µ–Ω–Ω–∞—è –ø–ª–æ—â–∞–¥—å', '–°–ø–∞—Å—Å–∫–∞—è', '–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è',
        '–°—Ç–∞—Ä–∞—è –î–µ—Ä–µ–≤–Ω—è', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç–∏—Ç—É—Ç', '–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è', '–ß–µ—Ä–Ω—ã—à–µ–≤—Å–∫–∞—è', '–ß–∫–∞–ª–æ–≤—Å–∫–∞—è'
    ],
    moscow: [
        '–ê–≤–∏–∞–º–æ—Ç–æ—Ä–Ω–∞—è', '–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∞—è', '–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è', '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤—Å–∫–∏–π —Å–∞–¥', '–ê–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è',
        '–ê–ª—Ç—É—Ñ—å–µ–≤–æ', '–ê–Ω–Ω–∏–Ω–æ', '–ê—Ä–±–∞—Ç—Å–∫–∞—è', '–ê—ç—Ä–æ–ø–æ—Ä—Ç', '–ë–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è',
        '–ë–∞–≥—Ä–∞—Ç–∏–æ–Ω–æ–≤—Å–∫–∞—è', '–ë–∞—Ä—Ä–∏–∫–∞–¥–Ω–∞—è', '–ë–∞—É–º–∞–Ω—Å–∫–∞—è', '–ë–µ–≥–æ–≤–∞—è', '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è',
        '–ë–µ–ª—è–µ–≤–æ', '–ë–∏–±–∏—Ä–µ–≤–æ', '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º. –õ–µ–Ω–∏–Ω–∞', '–ë–æ—Ä–æ–≤–∏—Ü–∫–∞—è', '–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥',
        '–ë—Ä–∞—Ç–∏—Å–ª–∞–≤—Å–∫–∞—è', '–ë—É–ª—å–≤–∞—Ä –î–º–∏—Ç—Ä–∏—è –î–æ–Ω—Å–∫–æ–≥–æ', '–ë—É–Ω–∏–Ω—Å–∫–∞—è –∞–ª–ª–µ—è', '–í–∞—Ä—à–∞–≤—Å–∫–∞—è', '–í–î–ù–•',
        '–í–ª–∞–¥—ã–∫–∏–Ω–æ', '–í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω', '–í–æ–π–∫–æ–≤—Å–∫–∞—è', '–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç', '–í–æ–ª–∂—Å–∫–∞—è',
        '–í–æ—Ä–æ–±—å—ë–≤—ã –≥–æ—Ä—ã', '–í—ã—Å—Ç–∞–≤–æ—á–Ω–∞—è', '–í—ã—Ö–∏–Ω–æ', '–î–µ–ª–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä', '–î–∏–Ω–∞–º–æ'
    ]
};

// –î–æ–±–∞–≤—å—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function generateDeviceId() {
    let deviceId = localStorage.getItem('metroDeviceId');
    if (!deviceId) {
        deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem('metroDeviceId', deviceId);
    }
    return deviceId;
}

const currentDeviceId = generateDeviceId();

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function getElementSafe(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`‚ùå –≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
    }
    return element;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function initializeDOMElements() {
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤...');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
    setupScreen = getElementSafe('setup-screen');
    waitingRoomScreen = getElementSafe('waiting-room-screen');
    joinedRoomScreen = getElementSafe('joined-room-screen');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    backToSetupBtn = getElementSafe('back-to-setup');
    backToWaitingBtn = getElementSafe('back-to-waiting');
    leaveGroupBtn = getElementSafe('leave-group');
    enterWaitingRoomBtn = getElementSafe('enter-waiting-room');
    confirmStationBtn = getElementSafe('confirm-station');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–π–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º
    wagonSelect = getElementSafe('wagon-select');
    colorSelect = getElementSafe('color-select');
    waitingTimer = getElementSafe('waiting-room-timer');
    waitingTimerDisplay = getElementSafe('waiting-timer-display');
    waitingTimerStatus = getElementSafe('waiting-timer-status');
    waitingStartTimerBtn = getElementSafe('waiting-start-timer');
    waitingStopTimerBtn = getElementSafe('waiting-stop-timer');
    waitingTimerExpanded = getElementSafe('waiting-timer-expanded');
    
    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    groupMembersContainer = getElementSafe('group-members');
    metroMap = getElementSafe('metro-map');
    requestsContainer = getElementSafe('requests-container');
    
    // –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    positionCards = document.querySelectorAll('#position-cards .state-card');
    moodCards = document.querySelectorAll('#mood-cards .state-card');
    
    console.log('‚úÖ DOM —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
}

// –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
async function handleEnterWaitingRoom() {
    console.log('üö™ –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è');
    
    const getRandomName = (gender) => {
        const names = gender === 'male' ? maleNames : femaleNames;
        const baseName = names[Math.floor(Math.random() * names.length)];
        return `${baseName}#${currentDeviceId.substr(-4)}`;
    };
    
    const randomName = getRandomName(selectedGender);
    
    const userData = {
        name: randomName,
        station: '',
        wagon: '',
        color: '',
        colorCode: getRandomColor(),
        status: '–í —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è',
        timer: "00:00",
        online: true,
        city: selectedCity,
        gender: selectedGender,
        position: '',
        mood: '',
        isWaiting: true,
        isConnected: false,
        deviceId: currentDeviceId
    };
    
    console.log('üìç –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);

    try {
        const validatedData = validateUserData(userData);
        const createdUser = await createUser(validatedData);
        
        if (createdUser) {
            currentUser = createdUser;
            userId = createdUser.id;
            
            if (setupScreen && waitingRoomScreen) {
                setupScreen.classList.remove('active');
                waitingRoomScreen.classList.add('active');
                
                loadOptionalModules().then(() => {
                    initializeWaitingRoomTimer();
                    initializeStateCards();
                    startGlobalRefresh();
                });
                
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω:', createdUser.name);
            }
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        
        const errorMessage = error.message.includes('Failed to fetch')
            ? '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.'
            : `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ${error.message}`;
        
        alert(errorMessage);
        
        const retry = confirm('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞?');
        if (retry) {
            handleEnterWaitingRoom();
        }
    }
}

function handleBackToSetup() {
    console.log('üîô –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º');
    setupScreen.classList.add('active');
    waitingRoomScreen.classList.remove('active');
    stopGlobalRefresh();
}

function handleBackToWaiting() {
    console.log('üîô –ù–∞–∑–∞–¥ –∫ –æ–∂–∏–¥–∞–Ω–∏—é');
    waitingRoomScreen.classList.add('active');
    joinedRoomScreen.classList.remove('active');
}

async function handleConfirmStation() {
    console.log('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Å—Ç–∞–Ω—Ü–∏—é');
    
    let colorValue = '';
    if (colorSelect && colorSelect.value) {
        colorValue = colorSelect.value;
    }
    
    if (!colorValue) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ü–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π –æ–¥–µ–∂–¥—ã');
        return;
    }
    
    if (!currentSelectedStation) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ');
        return;
    }
    
    let wagonValue = '';
    if (wagonSelect && wagonSelect.value) {
        wagonValue = wagonSelect.value;
    }
    
    if (userId) {
        try {
            await safeUserUpdate(userId, {
                station: currentSelectedStation,
                wagon: wagonValue,
                color: colorValue,
                is_waiting: false,
                is_connected: true,
                status: '–í—ã–±—Ä–∞–ª —Å—Ç–∞–Ω—Ü–∏—é: ' + currentSelectedStation
            });

            updateStationTitle(currentSelectedStation);

            if (typeof joinStation === 'function') {
                await joinStation(currentSelectedStation);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
}

async function handleLeaveGroup() {
    console.log('üö™ –ü–æ–∫–∏–¥–∞–µ–º –≥—Ä—É–ø–ø—É');
    
    currentPosition = '';
    currentMood = '';
    
    if (userId) {
        try {
            await safeUserUpdate(userId, { 
                status: '–û–∂–∏–¥–∞–Ω–∏–µ',
                is_waiting: true,
                is_connected: false,
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        }
    }
    
    currentGroup = null;
    joinedRoomScreen.classList.remove('active');
    waitingRoomScreen.classList.add('active');
    
    console.log('‚úÖ –í—ã—à–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ –∏ –ø–æ–ª–∞
function initializeCityAndGenderSelection() {
    const cityOptions = document.querySelectorAll('.city-option');
    cityOptions.forEach(option => {
        option.addEventListener('click', function() {
            cityOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            selectedCity = this.getAttribute('data-city');
            console.log('üìç –í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥:', selectedCity);
        });
    });

    const genderOptions = document.querySelectorAll('.gender-option');
    genderOptions.forEach(option => {
        option.addEventListener('click', function() {
            genderOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            selectedGender = this.getAttribute('data-gender');
            console.log('üë§ –í—ã–±—Ä–∞–Ω –ø–æ–ª:', selectedGender);
        });
    });
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function validateUserData(userData) {
    const required = ['name', 'city', 'gender'];
    const missing = required.filter(field => !userData[field]);
    
    if (missing.length > 0) {
        throw new Error(`–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missing.join(', ')}`);
    }
    
    return {
        ...userData,
        name: userData.name.trim() || '–ê–Ω–æ–Ω–∏–º',
        station: userData.station || '',
        wagon: userData.wagon || '',
        color: userData.color || '–°–∏–Ω–∏–π',
        status: userData.status || '–û–∂–∏–¥–∞–Ω–∏–µ'
    };
}

// API —Ñ—É–Ω–∫—Ü–∏–∏
async function createUser(userData) {
    try {
        console.log('üìç –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);
        
        const response = await fetch(`${API_BASE}/users`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        console.log('üìç –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        if (!response.ok) {
            let errorMessage = `HTTP error! status: ${response.status}`;
            
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
                console.error('üìç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', errorData);
            } catch (e) {
                console.error('üìç –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–ª–æ –æ—à–∏–±–∫–∏');
            }
            
            throw new Error(errorMessage);
        }
        
        const result = await response.json();
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ:', result);
        return result;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        
        // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ
        const fallbackUser = {
            id: Math.floor(Math.random() * 10000) + 1,
            name: userData.name || '–ê–Ω–æ–Ω–∏–º',
            station: userData.station || '',
            wagon: userData.wagon || '',
            color: userData.color || '–°–∏–Ω–∏–π',
            color_code: userData.colorCode || getRandomColor(),
            status: userData.status || '–û–∂–∏–¥–∞–Ω–∏–µ',
            city: userData.city || 'spb',
            gender: userData.gender || 'male',
            online: true,
            isFallback: true
        };
        
        try {
            const localUsers = JSON.parse(localStorage.getItem('metroUsers') || '[]');
            localUsers.push(fallbackUser);
            localStorage.setItem('metroUsers', JSON.stringify(localUsers));
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ');
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        }
        
        return fallbackUser;
    }
}

async function getUsers() {
    try {
        console.log('üîÑ –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞...');
        const response = await fetch(`${API_BASE}/users`);
        
        console.log('üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const users = await response.json();
        console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', users.length);
        return users.map((user, index) => ({
            ...user,
            id: user.id || index + 1
        }));
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        return [];
    }
}

async function safeUserUpdate(userId, updates) {
    try {
        console.log('üìç –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', { userId, updates });
        
        const response = await fetch(`${API_BASE}/users/${userId}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω:', result);
        return result;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        return null;
    }
}

async function deleteUser(userId) {
    try {
        await fetch(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
function startGlobalRefresh() {
    if (globalRefreshInterval) {
        clearInterval(globalRefreshInterval);
    }
    
    globalRefreshInterval = setInterval(async () => {
        console.log('üîÑ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
        
        if (waitingRoomScreen && waitingRoomScreen.classList.contains('active')) {
            if (typeof loadStationsMap === 'function') await loadStationsMap();
            if (typeof loadRequests === 'function') await loadRequests();
            if (typeof restoreSelectedStation === 'function') restoreSelectedStation();
        } else if (joinedRoomScreen && joinedRoomScreen.classList.contains('active')) {
            if (typeof loadGroupMembers === 'function') await loadGroupMembers();
            if (typeof loadRequests === 'function') await loadRequests();
        }
        
        await pingActivity();
        
    }, 5000);
    
    console.log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥—ã');
}

function stopGlobalRefresh() {
    if (globalRefreshInterval) {
        clearInterval(globalRefreshInterval);
        globalRefreshInterval = null;
        console.log('‚èπÔ∏è –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function showSetup() {
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    setupScreen.classList.add('active');
    stopGlobalRefresh();
}

function showWaitingRoom() {
    if (!userId) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å');
        return showSetup();
    }
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    waitingRoomScreen.classList.add('active');
    
    loadOptionalModules().then(() => {
        startGlobalRefresh();
    });
}

function showJoinedRoom() {
    if (!currentGroup) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é');
        return;
    }
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    joinedRoomScreen.classList.add('active');
    
    setTimeout(() => {
        forceInitializeJoinedRoom();
    }, 100);
    
    loadOptionalModules().then(() => {
        startGlobalRefresh();
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getRandomColor() {
    const colors = ['#dc3545', '#007bff', '#28a745', '#ffc107', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997'];
    return colors[Math.floor(Math.random() * colors.length)];
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöá DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    initializeDOMElements();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    if (enterWaitingRoomBtn) {
        enterWaitingRoomBtn.addEventListener('click', handleEnterWaitingRoom);
    }
    
    if (backToSetupBtn) {
        backToSetupBtn.addEventListener('click', handleBackToSetup);
    }
    
    if (backToWaitingBtn) {
        backToWaitingBtn.addEventListener('click', handleBackToWaiting);
    }
    
    if (leaveGroupBtn) {
        leaveGroupBtn.addEventListener('click', handleLeaveGroup);
    }
    
    if (confirmStationBtn) {
        confirmStationBtn.addEventListener('click', handleConfirmStation);
    }
    
    initializeCityAndGenderSelection();
    
    console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏—è
let lastPingTime = 0;
const PING_COOLDOWN = 5000;

async function pingActivity() {
    if (userId) {
        const now = Date.now();
        if (now - lastPingTime < PING_COOLDOWN) {
            return false;
        }
        
        lastPingTime = now;
        try {
            await fetch(`${API_BASE}/users/${userId}/ping`, { method: 'POST' });
            console.log('‚úÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            return true;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
            return false;
        }
    }
}

window.addEventListener('beforeunload', async function() {
    stopGlobalRefresh();
    
    if (userId) {
        try {
            await deleteUser(userId);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        }
    }
});

document.addEventListener('click', pingActivity);
document.addEventListener('keypress', pingActivity);